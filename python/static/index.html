<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>ESP32 JARVIS Bridge</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        color-scheme: dark;
        font-family: "Segoe UI", Tahoma, sans-serif;
        background-color: #0a0d14;
        color: #f1f5f9;
      }
      body {
        margin: 0;
        padding: 2rem;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
      }
      h1 {
        margin: 0;
        font-size: 1.8rem;
        letter-spacing: 0.1rem;
        text-transform: uppercase;
      }
      .pill {
        padding: 0.35rem 0.75rem;
        border-radius: 999px;
        font-size: 0.85rem;
        background: #1f2937;
      }
      .pill.online {
        background: #0bba81;
        color: #042d20;
      }
      section {
        background: rgba(15, 23, 42, 0.65);
        border: 1px solid rgba(148, 163, 184, 0.2);
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 0 30px rgba(8, 47, 73, 0.1);
      }
      h2 {
        margin-top: 0;
        font-size: 1.2rem;
        letter-spacing: 0.05rem;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
      }
      th,
      td {
        text-align: left;
        padding: 0.5rem 0.75rem;
        border-bottom: 1px solid rgba(148, 163, 184, 0.15);
        font-size: 0.95rem;
      }
      th {
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.08rem;
        color: #94a3b8;
      }
      button,
      input[type="text"] {
        border-radius: 8px;
        border: none;
        padding: 0.6rem 1rem;
        font-size: 0.95rem;
        cursor: pointer;
        transition: transform 120ms ease, box-shadow 120ms ease;
        background: #2563eb;
        color: white;
      }
      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 8px 18px rgba(37, 99, 235, 0.35);
      }
      input[type="text"] {
        width: 100%;
        box-sizing: border-box;
        background: rgba(15, 23, 42, 0.92);
        border: 1px solid rgba(148, 163, 184, 0.3);
        color: inherit;
      }
      .controls {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 1rem;
        margin-top: 1.25rem;
      }
      .control-card {
        border: 1px solid rgba(148, 163, 184, 0.2);
        border-radius: 10px;
        padding: 1rem;
        background: rgba(30, 41, 59, 0.55);
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }
      .muted {
        color: #94a3b8;
        font-size: 0.85rem;
      }
      pre {
        margin: 0.6rem 0 0;
        padding: 0.75rem;
        background: rgba(15, 23, 42, 0.75);
        border-radius: 8px;
        font-size: 0.85rem;
        overflow-x: auto;
      }
      ul.log-list {
        list-style: none;
        padding: 0;
        margin: 1rem 0 0;
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
        max-height: 240px;
        overflow-y: auto;
      }
      ul.log-list li {
        padding: 0.6rem 0.75rem;
        border-radius: 8px;
        background: rgba(30, 41, 59, 0.6);
        border: 1px solid rgba(148, 163, 184, 0.2);
        font-size: 0.85rem;
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
      }
      ul.log-list li .ts {
        color: #94a3b8;
        font-size: 0.75rem;
        letter-spacing: 0.04rem;
      }
      ul.log-list li .msg {
        color: #e2e8f0;
      }
      footer {
        text-align: center;
        font-size: 0.8rem;
        color: #64748b;
        margin-top: 1.5rem;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>J.A.R.V.I.S. Bridge Console</h1>
      <span id="bridge-status" class="pill">Checking link…</span>
    </header>

    <section id="telemetry">
      <h2>Telemetry</h2>
      <p class="muted">
        Latest data reported by the ESP32 gateway. Values refresh every 3 seconds.
      </p>
      <table>
        <thead>
          <tr>
            <th>Device</th>
            <th>Updated</th>
            <th>Summary</th>
          </tr>
        </thead>
        <tbody id="telemetry-body">
          <tr>
            <td colspan="3" class="muted">Waiting for first telemetry packet…</td>
          </tr>
        </tbody>
      </table>
    </section>

    <section id="events">
      <h2>Recent Events & Logs</h2>
      <p class="muted">
        Top 10 events reported by the device. Includes alerts and remote logs.
      </p>
      <ul id="events-list" class="log-list">
        <li class="muted">Waiting for events...</li>
      </ul>
    </section>

    <section>
      <h2>Audio Controls</h2>
      <div class="controls">
        <div class="control-card">
          <strong>Play Preset</strong>
          <p class="muted">Trigger a bundled announcement from the data directory.</p>
          <button data-clip="alert_fall_detected.wav">Fall Detected Alert</button>
          <button data-clip="status_all_clear.wav">All Clear Update</button>
        </div>

        <div class="control-card">
          <strong>Play Custom URL</strong>
          <p class="muted">
            Provide a direct URL to a WAV file. It will be streamed by the ESP32 speaker.
          </p>
          <input
            id="custom-url"
            type="text"
            placeholder="https://example.com/path/to/sample.wav"
          />
          <button id="play-custom">Play URL</button>
        </div>
      </div>
      <pre id="last-command" class="muted">No audio commands queued yet.</pre>
    </section>

    <footer>
      Served by the local Python backend. Data files are hosted from
      <code>/data</code>, static assets from <code>/static</code>.
    </footer>

    <script>
      const telemetryBody = document.getElementById("telemetry-body");
      const bridgeStatus = document.getElementById("bridge-status");
      const lastCommand = document.getElementById("last-command");
      const eventsList = document.getElementById("events-list");

      function formatSummary(data) {
        if (!data || typeof data !== "object") {
          return "<span class='muted'>No payload</span>";
        }
        try {
          const fall = data.sensors?.fall;
          const vitals = data.sensors?.vitals;
          const temperature = data.sensors?.temperature;

          const chunks = [];
          if (fall) {
            chunks.push(
              `Fall: <strong>${fall.state ?? "?"}</strong>${fall.tiltDeg !== undefined ? ` @ ${fall.tiltDeg.toFixed(1)}°` : ""
              }`
            );
          }
          if (vitals) {
            const hr = vitals.heartRateValid ? `${vitals.heartRate} bpm` : "—";
            const spo2 = vitals.spo2Valid ? `${vitals.spo2}% SpO₂` : "—";
            chunks.push(`Vitals: HR ${hr}, SpO₂ ${spo2}`);
          }
          if (temperature) {
            const value = temperature.valueC ?? temperature.value;
            if (value !== undefined) {
              chunks.push(`Temperature: ${Number(value).toFixed(1)} °C`);
            }
          }
          if (chunks.length === 0) {
            return "<span class='muted'>Telemetry received</span>";
          }
          return chunks.join(" · ");
        } catch (_err) {
          return "<span class='muted'>Telemetry received</span>";
        }
      }

      function renderEvents(events) {
        eventsList.innerHTML = "";
        if (!events || events.length === 0) {
          const li = document.createElement("li");
          li.className = "muted";
          li.textContent = "No events yet.";
          eventsList.appendChild(li);
          return;
        }
        const limited = events.slice(-10).reverse();
        for (const evt of limited) {
          const li = document.createElement("li");
          const ts = document.createElement("span");
          ts.className = "ts";
          ts.textContent = evt.isoTimestamp ?? new Date().toISOString();
          const message = document.createElement("span");
          message.className = "msg";
          const data = evt.data ?? {};
          const prefix = data.type ? `[${data.type}] ` : "";
          const content =
            data.message ??
            data.detail ??
            JSON.stringify(data)?.replace(/^{|}$/g, "") ??
            "Event";
          message.textContent = prefix + content;
          li.appendChild(ts);
          li.appendChild(message);
          eventsList.appendChild(li);
        }
      }

      function updateTelemetryView(snapshot) {
        const devices = snapshot.devices ?? [];
        telemetryBody.innerHTML = "";

        if (devices.length === 0) {
          telemetryBody.innerHTML =
            "<tr><td colspan='3' class='muted'>No telemetry yet.</td></tr>";
          return;
        }

        for (const device of devices) {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td><strong>${device.deviceId}</strong></td>
            <td>${device.isoTimestamp ?? "—"}</td>
            <td>${formatSummary(device.data)}</td>
          `;
          telemetryBody.appendChild(row);
        }
      }

      async function fetchTelemetry() {
        try {
          const response = await fetch("/api/devices");
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          const snapshot = await response.json();
          const connected = snapshot.bridge?.connected;
          bridgeStatus.textContent = connected ? "ESP32 Connected" : "ESP32 Offline";
          bridgeStatus.className = connected ? "pill online" : "pill";
          updateTelemetryView(snapshot);
          renderEvents(snapshot.events ?? []);
        } catch (err) {
          bridgeStatus.textContent = "Backend unreachable";
          bridgeStatus.className = "pill";
          telemetryBody.innerHTML =
            "<tr><td colspan='3' class='muted'>Failed to load telemetry.</td></tr>";
          renderEvents([]);
          console.error("Failed to fetch telemetry:", err);
        }
      }

      async function queueAudio(body) {
        try {
          const response = await fetch("/api/audio/play", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          });
          const payload = await response.json();
          if (!response.ok) {
            throw new Error(payload?.detail || response.statusText);
          }
          lastCommand.textContent = `Queued: ${payload.command}`;
        } catch (err) {
          lastCommand.textContent = `Error: ${err.message}`;
        }
      }

      document.querySelectorAll("button[data-clip]").forEach((button) => {
        button.addEventListener("click", () => {
          const clip = button.getAttribute("data-clip");
          queueAudio({ clip });
        });
      });

      document.getElementById("play-custom").addEventListener("click", () => {
        const url = document.getElementById("custom-url").value.trim();
        if (!url) {
          lastCommand.textContent = "Please provide a valid URL.";
          return;
        }
        queueAudio({ url });
      });

      fetchTelemetry();
      setInterval(fetchTelemetry, 3000);
    </script>
  </body>
</html>
